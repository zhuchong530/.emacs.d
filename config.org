:PROPERTIES:
:ID:       d8f6fe9a-74a1-4413-9c1f-029dba18071c
:END:
#+title: Literate Emacs config
#+OPTIONS: ^:{}

* 什么是文学编程

文学编程(Literate programming), 由Donald Knuth于1984年提出：

#+begin_quote
Instead of imagining that our main task is to instruct a computer what to do, let us concentrate rather on explaining to human beings what we want a computer to do.
#+end_quote

** 如何使用文学编程编写Emacs配置文件

在 =init.el= 文件中,使用 ~org-babel-load-file~ 引入org文件, 例如：

#+begin_quote
(org-babel-load-file "~/.emacs.d/config.org")
#+end_quote

上面这条语句实际是通过 ~org-babel-tangle~ 将文件中的配置代码导出到文件 =~/.emacs.d/emacs-config.el= 。然后使用 ~load-file~ 加载结果文件，效果如同：

#+begin_quote
(load-file "~/.emacs.d/config.org")
#+end_quote

但是，它会检查 =config.org= 和 =config.el= 文件的时间戳， 如果 =config.org= 文件有变化，会自动重新生成 =config.el= 文件

* general settings

** 注释

为了符合Emacs规范，文件最前面必须是以下内容

#+begin_src emacs-lisp
  ;;; config.el --- Cathy.Chang's Emacs configuration -*- lexical-binding: t -*-

  ;; Copyright (C) 2008-2022 Cathy Chang

  ;; Author: Cathy.Chang <xxxxxxx@gmail.com>
  ;; Keywords: internal

  ;;; Commentary:
  ;; A Emacs config file generated from config.org automaticaly

  ;;; Code:
#+end_src

** 版本检查

检查Emacs版本，要求Emacs >= 26

#+begin_src emacs-lisp
  (when (version< emacs-version "26")
    (error "Requires at least GNU Emacs 26, but you're running %s" emacs-version))
#+end_src

** 编码

#+begin_src emacs-lisp
  (set-charset-priority 'unicode)
  (setq locale-coding-system 'utf-8)
  (set-terminal-coding-system 'utf-8)
  (set-keyboard-coding-system 'utf-8)
  (set-selection-coding-system 'utf-8)
  (prefer-coding-system 'utf-8)
  (setenv "LANG" "en_US.UTF-8")
  (setenv "LC_ALL" "en_US.UTF-8")
  (setenv "LC_CTYPE" "en_US.UTF-8")
#+end_src

** 配置包管理的源

#+begin_src emacs-lisp
  (require 'package)
  (setq package-archives '(("melpa" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/melpa/")
                           ;; ("org" . "http://mirrors.tuna.tsinghua.edu.cn/elpa/org/")
                           ("gnu" . "https://mirrors.tuna.tsinghua.edu.cn/elpa/gnu/")))
  (package-initialize)
#+end_src

** use-package

[[https://github.com/jwiegley/use-package][官方]]
[[https://jwiegley.github.io/use-package/][官方文档]]

这个包实际是宏(macro)，可以隔离包配置。 具体参见这里： [[id:66760557-2681-41d4-8e02-ea68fe02e805][use-package]]

#+begin_src emacs-lisp
  (unless (package-installed-p 'use-package)
    (package-refresh-contents)
    (package-install 'use-package)
    (package-install 'diminish)
    (package-install 'bind-key))

  (eval-when-compile
    (require 'use-package))
  (require 'diminish)
  (require 'bind-key)
  (setq use-package-verbose t)
  (setq use-package-always-ensure t)
#+end_src

** Garbage Collector Magic Hack

[[https://github.com/emacsmirror/gcmh][官网]]

强化GC回收

#+begin_src emacs-lisp
  (use-package gcmh
    :init
    (setq gcmh-idle-delay 5)
    (setq gcmh-high-cons-threshold (* 64 1024 1024)) ;64MB
    (gcmh-mode 1))
#+end_src

** exec-path-from-shell

[[https://github.com/purcell/exec-path-from-shell][官网]]

这个包确保Emacs中的环境变量和用户shell中的一致

#+begin_src emacs-lisp
  (use-package exec-path-from-shell
    :config (exec-path-from-shell-initialize))
#+end_src

** Emacs内建功能

具体信息可以查询[[https://www.gnu.org/software/emacs/manual/html_mono/emacs.html][官网文档]]

*** 各种bar

工具栏，滚动栏，菜单栏 全部不要！

#+begin_src emacs-lisp
  (when (window-system)
    (tool-bar-mode -1)
    (scroll-bar-mode -1)
    (menu-bar-mode -1))
#+end_src

*** 关掉启动信息啥的

#+begin_src emacs-lisp
  ;; No need to see GNU agitprop
  (setq inhibit-startup-screen t)
  ;; No need to remind me what a scratch buffer is
  (setq inhibit-startup-message nil)
  (setq inhibit-startup-echo-area-message t)
#+end_src

*** 关掉ring-bell

#+begin_src emacs-lisp
  (setq ring-bell-function 'ignore)
#+end_src

*** symlink处理

#+begin_src emacs-lisp
  (setq find-file-visit-truename t)
  (setq vc-follow-symlinks t)
#+end_src

*** 缩进用空格而不是tab

#+begin_src emacs-lisp
  ;; Never mix tabs and spaces. Never use tabs, period.
  ;; We need the setq-default here because this becomes
  ;; a buffer-local variable when set.
  (setq-default indent-tabs-mode nil)
#+end_src

*** 超长文件处理

#+begin_src emacs-lisp
  (global-so-long-mode)                   ;Handle long files
#+end_src

*** 高亮当前行

这里设置为全局

#+begin_src emacs-lisp
  (global-hl-line-mode t)
#+end_src

*** 自动折行

#+begin_src emacs-lisp
  (global-visual-line-mode t)
#+end_src

*** Delete region when yank on top of it

#+begin_src emacs-lisp
  (delete-selection-mode t)
#+end_src

*** 不生成备份文件

#+begin_src emacs-lisp
  (setq make-backup-files nil)
#+end_src

*** 关闭自动保存

#+begin_src emacs-lisp
  (setq auto-save-default nil)
#+end_src

*** 其他选项配置

先这样吧，回头慢慢搞

#+begin_src emacs-lisp
  (setq
   ;; Double-spaces after periods is morally wrong
   sentence-end-double-space nil
   ;; Save existing clipboard text into the kill ring before replacing it.
   save-interprogram-paste-before-kill t
   ;; Prompts should go in the minibuffer, not in a GUI
   use-dialog-box nil
   ;; Fix undo in commands affecting the mark
   mark-even-if-inactive nil
   ;; if NIL, kill whole line and move the next line up
   kill-whole-line t
   ;; accept 'y' or 'n' instead of yes/no
   use-short-answers t
   default-directory "~/Programme/"
   ;; prefer newer elisp files
   load-prefer-newer t
   ;; disable lock files, losing benefits of simultaneous editing
   create-lockfiles nil
   global-mark-ring-max 5000         ; increase mark ring to contains 5000 entries
   mark-ring-max 5000                ; increase kill ring to contains 5000 entries
   confirm-kill-emacs 'y-or-n-p
   ;; specifies the maximum length of a minibuffer history list
   history-length                     1000
   ;; Disable non selected window highlight
   cursor-in-non-selected-windows     nil
   highlight-nonselected-windows      nil
   ;; PATH
   exec-path                          (append exec-path '("/usr/local/bin/"))
   ;; Backups disabled
   backup-inhibited                   t
   fringes-outside-margins            t
   select-enable-clipboard          t
   frame-resize-pixelwise t
   ;; delete to trash
   delete-by-moving-to-trash t
   ;; highlight syntax
   global-font-lock-mode t
   )
  (defalias 'yes-or-no-p 'y-or-n-p)
  ;; default to 4 visible spaces to display a tab
  (setq-default tab-width 4)
  (set-fringe-mode 10)
#+end_src

*** modeline上显示内容

即使没有安装插件，(或者运行 ~emacs -Q~ )，也需要这样的设置，

#+begin_src emacs-lisp
  ;; Feature mode
  (setq column-number-mode t
        display-time-day-and-date t
        size-indication-mode -1)
#+end_src

*** 保存Emacs会话

#+begin_src emacs-lisp
  ;; Save backup files in a dedicated directory
  (use-package desktop
    :config (desktop-save-mode)
    :custom
    (desktop-restore-eager 1)
    (desktop-lazy-idle-delay 1)
    (desktop-lazy-verbose nil)
    )
#+end_src

*** 保存编辑位置

打开文件，回到上次编辑位置

#+begin_src emacs-lisp
  ;; history
  (use-package saveplace
    :config (save-place-mode))
#+end_src

*** 保存minibuff历史

#+begin_src emacs-lisp
  (use-package savehist
    :config (savehist-mode))
#+end_src

*** 外部程序修改文件后，自动加载文件

#+begin_src emacs-lisp
  ;; Automatically reload files was modified by external program
  (use-package autorevert
    :diminish
    :hook (after-init . global-auto-revert-mode)
    )
#+end_src

*** 括号匹配

#+begin_src emacs-lisp
  (setq-default show-paren-style 'expression
                show-paren-delay 0
                show-paren-highlight-openparen t
                show-paren-when-point-inside-paren nil
                show-paren-when-point-in-periphery t)
  (show-paren-mode t)
#+end_src

*** line number

#+begin_src emacs-lisp
  ;; line numbers, after Emacs 26
  (global-display-line-numbers-mode)
#+end_src

*** whitespace

显示空白字符

#+begin_src emacs-lisp
  ;; activate whitespace-mode to view all whitespace characters
  (global-set-key (kbd "C-c w") 'whitespace-mode)
  ;; show unncessary whitespace that can mess up your diff
  (add-hook 'prog-mode-hook (lambda () (interactive) (setq show-trailing-whitespace 1)))
#+end_src

* UI


** doom-themes

我用 ~doom-themes~, 具体见[[https://github.com/doomemacs/themes][官网]]

#+begin_src emacs-lisp
  (use-package doom-themes
    :config
    (setq doom-themes-enable-bold t       ; if nil,  bold is universally disabled
          doom-themes-enable-italic t)    ; if nil, italics is universally disabled
    (load-theme 'doom-dracula t)
    (load-theme 'doomacario-light t)      ; a ligh theme
    ;; Enable flashing mode-line on errors
    (doom-themes-visual-bell-config)
    ;; Corrects (and improves) org-mode's native fontification.
    (doom-themes-org-config))
#+end_src

** doom-modeline

美化modeline， 具体见[[https://github.com/seagle0128/doom-modeline][官网]]

#+begin_src emacs-lisp
  (use-package doom-modeline
    :hook (after-init . doom-modeline-mode)
    :custom
    (setq doom-modeline-height 25)
    (setq doom-modeline-bar-width 4)
    (setq doom-modeline-project-detection 'projectile)
    (setq doom-modeline-buffer-file-name-style 'auto)
    (setq doom-modeline-icon (display-graphic-p))
    (setq doom-modeline-major-mode-icon t)
    (setq doom-modeline-buffer-modification-icon t)
    (setq doom-modeline-hud t)
    (setq doom-modeline-time-icon t)
    (setq doom-modeline-buffer-modification-icon t)
    (setq doom-modeline-env-version t)
    (setq doom-modeline-buffer-encoding t))
#+end_src

** 字体

在系统shell里通过 ~fc-list~ 命令，找到对应family的名字

#+begin_src emacs-lisp
  ;; (set-frame-font "Fira Code-12")
  (set-face-attribute
   'default nil
   :family "YaHei Consolas Hybrid"
   ;; :family "JetBrains Mono"
   ;; :family "MesloLGL Nerd Font Mono"
   ;; :family "Monaco"
   ;; :family "Fira Code"
   :height 120
   :weight 'normal)
#+end_src

** 图标

*** all-the-icons

#+begin_src emacs-lisp
  (use-package all-the-icons
    :if (display-graphic-p)
    )
#+end_src

*** all-the-icons-dired

#+begin_src emacs-lisp
(use-package all-the-icons-dired
:after all-the-icons
:hook (dired-mode . all-the-icons-dired-mode)
)
#+end_src

** 最大化

#+begin_src emacs-lisp
  (toggle-frame-maximized)
#+end_src

* 编辑器增强

** 基础

[[https://github.com/bbatsov/crux][官网]]，这包提供一些常用函数扩展，从Emacs Prelude里面来

#+begin_src emacs-lisp
  (use-package crux
  :bind (("C-a" . crux-move-beginning-of-line)))
#+end_src

保存时移除每一行最后的空白字符

#+begin_src emacs-lisp
  (add-hook 'before-save-hook 'delete-trailing-whitespace)
#+end_src

** which-key

这个包是一个 =minor mode= ，可以根据当前按键，提示可能的键绑定。具体见[[https://github.com/justbur/emacs-which-key][官网]]

#+begin_src emacs-lisp

  (use-package which-key                  ;bring up help on key combinations
    :diminish
    :hook (after-init . which-key-mode)
    :config
    (which-key-setup-side-window-bottom))
#+end_src

** ace-window

用于窗口切换，当有多个窗口时，每个窗口会显示一个数字，通过数字就可以跳到该窗口。具体见： [[https://github.com/abo-abo/ace-window][官网]]

Emacs本身自带 ~other-window~ 函数，绑定到 ~C-x o~ 上，所以这里我将 ~ace-window~ 绑定到 ~C-c o~

#+begin_src emacs-lisp
  ;; package ace-window
  (use-package ace-window
    :config
    (global-set-key (kbd "C-c o") 'ace-window)
    ;; 设置为frame后会忽略treemacs frame，否则即使两个窗口时也会提示选择
    (setq aw-scope 'frame)
    ;; 调大窗口选择字符
    (custom-set-faces
     '(aw-leading-char-face
       ((t (:inherit ace-jump-face-foreground :foreground "red" :height 5.0)))))
    )
#+end_src

** ace-jump-mode

[[https://github.com/winterTTr/ace-jump-mode][官网]]

Emacs的 =minor mode= ，用来移动光标到任意位置（你指定的）

#+begin_src emacs-lisp

  ;;package ace-jump-mode
  (use-package ace-jump-mode
    :bind ("C-c <SPC>" . ace-jump-mode)
    )
#+end_src

** volatile-highlights

这是Emacs的一个 =minor mode= 用于可视化反馈。 比如当你粘贴一段文本的时候，这段文本会被高亮直到你有进一步的操作，具体见:[[https://github.com/k-talo/volatile-highlights.el][官网]]

#+begin_src emacs-lisp
  (use-package volatile-highlights
    :commands (volatile-highlights-mode)
    :init
    (add-hook 'after-init-hook 'volatile-highlights-mode)
    :config
    (set-face-attribute 'vhl/default-face nil
                        :underline "slate gray"))
#+end_src

** undo-tree

[[https://www.dr-qubit.org/undo-tree.html][官网]]

将undo历史可视化成一个tree，方便navigation

#+begin_src emacs-lisp
  (use-package undo-tree
    :init (progn
            (global-undo-tree-mode)
            (setq undo-tree-visualizer-timestamps t)
            (setq undo-tree-auto-save-history nil)
            (setq undo-tree-visualizer-diff t))
    )
#+end_src

** uniquify

build-in功能

当Emacs打开具有相同名字的多个文件，增加前缀以示区别。具体见: [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Uniquify.html][这里]]

#+begin_src emacs-lisp
  ;; (use-package uniquify
    ;; :config
    (setq
     uniquify-buffer-name-style 'forward
     uniquify-separator ":"
     uniquify-after-kill-buffer-p t
     uniquify-ignore-buffers-re "^\\*")
  ;; )
#+end_src

** 括号配对

built-in功能，Emacs 24引入

自动闭合括号等，具体见： [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Matching.html][这里]]

#+begin_src emacs-lisp
  ;; auto close bracket insertion. New in emacs 24
  ;; built-in electric-pair
  (electric-pair-mode 1)
  ;; make electric-pair-mode work on more brackets
  (setq electric-pair-pairs
        '(
          (?\" . ?\")
          (?\' . ?\')
          (?\[ . ?\])
          (?\` . ?\`)
          (?\{ . ?\})))
#+end_src

** comment-dwim-2

[[https://github.com/remyferre/comment-dwim-2][官网]]

~comment-dwim-2~ 用来替代Emacs内建的命令 ~comment-dwim~ ，用于注释，但是包含很多额外的特性。

#+begin_src emacs-lisp
  (use-package comment-dwim-2
    :bind ("M-;" . comment-dwim-2)
    )
#+end_src

** iedit

[[https://github.com/victorhge/iedit][官网]]

主要用于多点编辑

#+begin_src emacs-lisp
  (use-package iedit
    :init (setq iedit-toggle-key-default nil)
    :bind ("C-;" . iedit-mode)
    )
#+end_src

** highlight-indent-guides

之前用 ~indent-guide~ 但是这个包不更新了，换成 ~highlight-indent-guides~ 试试。见：[[https://github.com/DarthFennec/highlight-indent-guides][官网]]

这个包用于显示一个缩进标尺

#+begin_src emacs-lisp
  (use-package highlight-indent-guides
    :hook (prog-mode-hook . highlight-indent-guides-mode))
#+end_src

** highlight-symbol

自动or手动高亮符号， 具体见: [[https://github.com/nschum/highlight-symbol.el][官网]]

#+begin_src emacs-lisp
  (use-package highlight-symbol
    :bind(("C-<f3>" . highlight-symbol)
          ("<f3>" . highlight-symbol-next)
          ("S-<f3>" . highlight-symbol-prev)
          ("M-<f3>" . highlight-symbol-query-replace))
    :config
    (add-hook 'highlight-symbol-mode-hook
              (function
               (lambda () (highlight-symbol-nav-mode +1))))
    )
#+end_src

** golden-ratio

[[https://github.com/roman/golden-ratio.el][官网]]

当有多个窗口(window)的时候，有些窗口大小不太适合编辑。这个包可以自动缩放当前的窗口到合适大小

#+begin_src emacs-lisp

  ;;package golden-ratio
  (use-package golden-ratio
    :init (golden-ratio-mode 1)
    :config (setq golden-ratio-exclude-modes '("ediff-mode"
                                               "gud-mode"
                                               "gdb-locals-mode"
                                               "gdb-registers-mode"
                                               "gdb-breakpoints-mode"
                                               "gdb-threads-mode"
                                               "gdb-frames-mode"
                                               "gdb-inferior-io-mode"
                                               "gud-mode"
                                               "gdb-inferior-io-mode"
                                               "gdb-disassembly-mode"
                                               "gdb-memory-mode"
                                               "IELM"
                                               ;; "eshell-mode" "dired-mode"))
                                               )))
#+end_src

** centaur-tabs

增加标签页功能，Emacs有自己的 =tab-bar-mode= ，但是这个感觉好用且好看一些，先用这个吧。具体见： [[https://github.com/roman/golden-ratio.el][官网]]

#+begin_src emacs-lisp
  (use-package centaur-tabs
    :demand
    :config
    (centaur-tabs-mode t)
    :init
    (setq centaur-tabs-set-bar t
          centaur-tabs-set-bar 'left
          centaur-tabs-height 32
          centaur-tabs-set-icons t
          centaur-tabs-set-modified-marker t
          centaur-tabs-modified-marker " ● "
          centaur-tabs-style "bar")
    :bind
    ("C-9" . centaur-tabs-backward)
    ("C-0" . centaur-tabs-forward))
#+end_src

** rainbow-mode

直接将颜色显示出来，具体见： [[https://github.com/emacsmirror/rainbow-mode][官网]]

#+begin_src emacs-lisp

  ;; rainbow mode for display the color
  (use-package rainbow-mode
    :diminish
    :hook (prog-mode . rainbow-mode))
#+end_src

** rainbow-delimiters

使用不同颜色，显示不同级别的匹配括号。具体见： [[https://github.com/Fanael/rainbow-delimiters][官网]]

#+begin_src emacs-lisp
  (use-package rainbow-delimiters
    :init (progn (add-hook 'prog-mode-hook 'rainbow-delimiters-mode))
    :config
    (set-face-foreground 'rainbow-delimiters-depth-1-face "chartreuse3")
    (set-face-foreground 'rainbow-delimiters-depth-2-face "DodgerBlue1")
    (set-face-foreground 'rainbow-delimiters-depth-3-face "DarkOrange2")
    (set-face-foreground 'rainbow-delimiters-depth-4-face "deep pink")
    (set-face-foreground 'rainbow-delimiters-depth-5-face "medium orchid")
    (set-face-foreground 'rainbow-delimiters-depth-6-face "turquoise")
    (set-face-foreground 'rainbow-delimiters-depth-7-face "lime green")
    (set-face-foreground 'rainbow-delimiters-depth-9-face "gold")
    (set-face-foreground 'rainbow-delimiters-depth-9-face "cyan")
    (set-face-bold 'rainbow-delimiters-depth-1-face "t")
    (set-face-bold 'rainbow-delimiters-depth-2-face "t")
    (set-face-bold 'rainbow-delimiters-depth-3-face "t")
    (set-face-bold 'rainbow-delimiters-depth-4-face "t")
    (set-face-bold 'rainbow-delimiters-depth-5-face "t")
    (set-face-bold 'rainbow-delimiters-depth-6-face "t")
    (set-face-bold 'rainbow-delimiters-depth-7-face "t")
    (set-face-bold 'rainbow-delimiters-depth-8-face "t")
    (set-face-bold 'rainbow-delimiters-depth-9-face "t")
    )
#+end_src

* 杂项

** helpful

增强Emacs内建帮助系统，具体见： [[https://github.com/Wilfred/helpful][官网]]

#+begin_src emacs-lisp
  (use-package helpful
    :config
    (global-set-key (kbd "C-h f") #'helpful-callable)
    (global-set-key (kbd "C-h v") #'helpful-variable)
    (global-set-key (kbd "C-h k") #'helpful-key)
    (global-set-key (kbd "C-c C-d") #'helpful-at-point)
    (global-set-key (kbd "C-h F") #'helpful-function)
    (global-set-key (kbd "C-h C") #'helpful-command)
    )
#+end_src

** nyan-mode

当前位置在buffer中的位置，使用一个彩虹猫展示。一切为了好看。 具体见： [[https://github.com/TeMPOraL/nyan-mode][官网]]

#+begin_src emacs-lisp
  (use-package nyan-mode
    :custom
    (nyan-cat-face-number 3)
    (nyan-animate-nyancat t)
    :config (nyan-mode 1))
#+end_src

** youdao-dictionary

有道词典查询接口。具体见：[[https://github.com/xuchunyang/youdao-dictionary.el][官网]]

#+begin_src emacs-lisp

  (use-package youdao-dictionary
    :config
    (setq url-automatic-caching t)
    )
  (global-set-key (kbd "C-c k") 'youdao-dictionary-search-at-point-tooltip)
#+end_src

** tramp

远程编辑，先这样吧

#+begin_src emacs-lisp
  ;;tramp
  ;;;;;;;;;;;;;;;;;;;;;;;;;tramp setting;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  ;;;;;;;;;;;Enable you to edit the file which on the REMOTE machines;;;;;
  ;;;  tramp support many protocols:like ftp,ssh,etc.
  ;;;USAGE:
  ;;   /host:filepath
  ;;   /user@host:filepath
  ;;   /user@host#port:filepath
  ;;   /method:user@host:filepath
  ;;   /method:user@host#port:filepath
  ;;;;;; method stand for which protocol you want to use.
  ;;;;;;  host stand for the remote hostname/Ip Address
  (use-package tramp)
#+end_src

** markdown-mode

编辑markdown文件，具体见: [[https://jblevins.org/projects/markdown-mode/][官网]]

先这样吧，用 =org-mode= 比较多。

#+begin_src emacs-lisp
  (use-package markdown-mode
    :commands (markdown-mode gfm-mode)
    :mode (("README\\.md\\'" . gfm-mode)
           ("\\.md\\'" . markdown-mode)
           ("\\.markdown\\'" . markdown-mode))
    :init (setq markdown-command "multimarkdown"))
#+end_src

* 通用补全

** orderless

提供模糊补全功能。具体见: [[https://github.com/oantolin/orderless][官网]]

#+begin_src emacs-lisp

  ;; Orderless
  ;; Controls the sorting of the minibuffer completions
  (use-package orderless
    :custom
    (completion-styles '(orderless basic))
    ;; (completion-category-defaults nil)
    (completion-category-overrides
     '((file (styles basic basic-remote ; For `tramp' hostname completion with `vertico'
                     orderless partial-completion)))))
#+end_src

** vertico

重用Emacs内建功能，提供补全功能。具体见: [[https://github.com/minad/vertico][官网]]

#+begin_src emacs-lisp

  (use-package vertico
    :init (vertico-mode)
    ;; Different scroll margin
    ;; (setq vertico-scroll-margin 0)
    ;; Show more candidates
    (setq vertico-count 20)
    ;; Grow and shrink the Vertico minibuffer
    (setq vertico-resize t)
    ;; Optionally enable cycling for `vertico-next' and `vertico-previous'
    ;; (setq vertico-cycle t)
    )
#+end_src

** consult

[[https://github.com/minad/consult][官网]]

这个包基于Emacs补全函数 ~completing-read~ 函数，可以从候选列表中快速选择一个item。

下面的配置基本来自官方建议

#+begin_src emacs-lisp

  (use-package consult
    :bind (("C-c h" . consult-history)
           ("C-c m" . consult-mode-command)
           ;; ("C-c k" . consult-kmacro)
           ("C-x M-:" . consult-complex-command) ;orig: repeat-complex-command
           ("C-x b" . consult-buffer)     ; orig: switch-to-buffer
           ("C-x r b" . consult-bookmark)
           ("C-x p b" . consult-project-buffer)
           ;; M-g bindings (goto-map)
           ("M-g e" . consult-compile-error)
           ;; ("M-g f" . consult-flymake)    ; Alternative: consult-flycheck
           ("M-g g" . consult-goto-line)  ; Orig: goto-line
           ("M-g M-g" . consult-goto-line) ; Orig: goto-line
           ("M-g o" . consult-outline)     ;Alternative: consult-org-heading
           ("M-g m" . consult-mark)
           ("M-g k" . consult-global-mark)
           ("M-g i" . consult-imenu)
           ("M-g I" . consult-imenu-multi)
           ;; M-s bindings (search-map)
           ("M-s d" . consult-find)
           ("M-s D" . consult-locate)
           ("M-s g" . consult-grep)
           ("M-s G" . consult-git-grep)
           ("M-s r" . consult-ripgrep)
           ("M-s l" . consult-line)
           ("M-s L" . consult-line-multi)
           ("M-s m" . consult-multi-occurg)
           ;; ("M-s k" . consult-keep-lines)
           ;; ("M-s u" . consult-focus-lines)
           ;; Isearch integration
           ("M-s e" . consult-isearch-history)
           :map isearch-mode-map
           ("M-e" . consult-isearch-history) ; orig: isearch-edit-string
           ("M-s e" . consult-isearch-history) ; orig: isearch-edit-string
           ("M-s l" . consult-line)            ; needed by consult-line to detect isearch
           ("M-s L" . consult-line-multi)      ; needed by consult-line to detect isearch
           ;; Minibuffer history
           :map minibuffer-local-map
           ("M-s" . consult-history)      ; orig: next-matching-history-element
           ("M-r" . consult-history))      ; orig: previous-matching-history-element
    ;; Enable automatic preview at point in the *Completions* buffer. This is
    ;; relevant when you use the default completion UI.
    :hook (completion-list-mode . consult-preview-at-point-mode)
    :init
    ;; Optionally configure the register formatting. This improves the register
    ;; preview for consult-register, consult-register-load, consult-register-store
    ;; and the Emacs built-ins
    (setq register-preview-delay 0.5
          register-preview-function #'consult-register-format)
    ;; Use consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)
    :config
    ;; For some commands and buffer sources it is useful to configure the
    ;; :preview-key on a per-command basis using the consult-customize macro
    (consult-customize
     consult-theme
     :preview-key '(:debounce 0.2 any)
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file consult-xref
     consult--source-bookmark consult--source-recent-file
     consult--source-project-recent-file
     :preview-key (kbd "M-."))
    (setq consult-narrow-key "<")
    )
#+end_src

** Marginalia

给minibuffer添加额外信息。见: [[https://github.com/minad/marginalia][官网]]

#+begin_src emacs-lisp

  ;; Marginalia
  ;; Enhances the minibuffer completions with additional informations
  (use-package marginalia
    :custom
    (marginalia-annotators
     '(marginalia-annotators-heavy marginalia-annotators-light nil))
    (marginalia-align 'left)
    :init (marginalia-mode))
#+end_src

** all-the-icons-completion

给补全系统里的candidates加上icon，见: [[https://github.com/iyefrat/all-the-icons-completion][官网]]

#+begin_src emacs-lisp
  (use-package all-the-icons-completion
    :after (marginalia all-the-icons)
    :hook (marginalia-mode . all-the-icons-completion-marginalia-setup)
    :init
    (all-the-icons-completion-mode))
#+end_src

* 编程

** 补全系统
*** corfu

补全功能，之前用 =company-mode= ，但是太重量了。所以换成corfu，具体见： [[https://github.com/minad/corfu][官网]]

#+begin_src emacs-lisp

  (use-package corfu
    :after (orderless lsp-bridge)
    :bind (:map corfu-map
                ("M-n" . corfu-next)
                ("M-p" . corfu-previous)
                ("TAB" . corfu-insert))
    :custom
    ;; (corfu-cycle t)
    ;; auto completion
    (corfu-auto t)
    (corfu-auto-delay 0.25)
    (corfu-auto-prefix 2)
    (corfu-max-width 110)
    (corfu-preview-current nil)
    (corfu-echo-documentation t)
    :config (global-corfu-mode))
#+end_src

*** yasnippet

模版补全，lsp-bridge也需要这个包。[[https://github.com/joaotavora/yasnippet][官网]]

#+begin_src emacs-lisp
  (use-package yasnippet
    :bind (:map yas-keymap
                ("C-i" . yas-next-field-or-maybe-expand))
    :hook ((prog-mode org-mode) . yas-minor-mode)
    :config
    (setq yas-snippet-dirs '("~/.emacs.d/snippets"))
    (yas-global-mode 1)
    )
#+end_src

*** posframe

弹出一个posframe(只是一个子frame)。lsp-bridge需要这个包 。[[https://github.com/tumashu/posframe][官网]]

#+begin_src emacs-lisp
  (use-package posframe)
#+end_src

*** lsp-bridge

LSP客户端。使用python的线程技术在Emacs和lsp服务器之间建立bridge，加速补全。

具体见: [[https://github.com/manateelazycat/lsp-bridge][官网]]

#+begin_src emacs-lisp
  ;; lsp-bridge
  (use-package lsp-bridge
    :load-path "~/.emacs.d/elpa/lsp-bridge"
    :bind
    (:map lsp-bridge-mode-map
          ("M-." . lsp-bridge-find-def)
          ("M-," . lsp-bridge-return-from-def)
          ("M-?" . lsp-bridge-find-references)
          ("M-i" . lsp-bridge-lookup-documentation)
          ("M-n" . lsp-bridge-popup-documentation-scroll-up)
          ("M-p" . lsp-bridge-popup-documentation-scroll-down)
          ("s-C-n" . lsp-bridge-jump-to-next-diagnostic)
          ("s-C-p" . lsp-bridge-jump-to-prev-diagnostic))
    :config
    (setq lsp-bridge-auto-format-code-idle 5)
    (setq lsp-bridge-enable-auto-format-code t)
    (setq lsp-bridge-enable-log nil)
    (setq lsp-bridge-enable-signature-help t)
    ;; (setq lsp-bridge-completion-provider 'corfu)
    (global-lsp-bridge-mode)
    )

  ;; (add-to-list 'load-path "~/.emacs.d/elpa/lsp-bridge")
  ;; (require 'lsp-bridge)
  ;; (global-lsp-bridge-mode)
#+end_src

** 文档帮助

*** zeal-at-point

Emacs和zealdoc接口，直接在zeal中查询文档，当然系统商首先要安装zealdoc这个软件，具体见：[[https://github.com/jinzhu/zeal-at-point][官网]]

#+begin_src emacs-lisp
  (use-package zeal-at-point
    :defer 10
    :bind ("C-c d" . 'zeal-at-point)
    :config
    (add-to-list 'zeal-at-point-mode-alist '(python-mode . "python3"))
    (add-to-list 'zeal-at-point-mode-alist '(c-mode . "C"))
    (add-to-list 'zeal-at-point-mode-alist '(c++-mode . "C++"))
    (add-to-list 'zeal-at-point-mode-alist '(cc-mode . ("C" "C++")))
    (add-to-list 'zeal-at-point-mode-alist '(go-mode . "Go"))
    )
#+end_src

*** eldoc

是一个 =minor mode= ，在echo area里显示函数参数

#+begin_src emacs-lisp
  (use-package eldoc
    :diminish eldoc-mode
    :config (add-hook 'prog-mode-hook 'eldoc-mode))
#+end_src


** programming languages


*** C/C++

#+begin_src emacs-lisp
  (use-package cc-mode
    :mode (("\\.hpp\\(h?\\|xx\\|pp\\)\\'" . c++-mode)
           ("\\.c\\'" . c-mode)
           ("\\.h\\'" . c-mode)
           ("\\.m\\'" . c-mode)
           ("\\.mm\\'" . c-mode))
    :config
    ;; Available C style:
    ;; “gnu”: The default style for GNU projects
    ;; “k&r”: What Kernighan and Ritchie, the authors of C used in their book
    ;; “bsd”: What BSD developers use, aka “Allman style” after Eric Allman.
    ;; “whitesmith”: Popularized by the examples that came with Whitesmiths C, an early commercial C compiler.
    ;; “stroustrup”: What Stroustrup, the author of C++ used in his book
    ;; “ellemtel”: Popular C++ coding standards as defined by “Programming in C++, Rules and Recommendations,” Erik Nyquist and Mats Henricson, Ellemtel
    ;; “linux”: What the Linux developers use for kernel development
    ;; “python”: What Python developers use for extension modules
    ;; “java”: The default style for java-mode (see below)
    ;; “user”: When you want to define your own style
    (setq c-set-style "gnu") ;; set style to "k&r"
    (setq c-basic-offset 4)
    (setq tab-width 4) ; or any other preferred value
    )
#+end_src

**** function-args - DISABLED

暂时先disable， [[https://github.com/abo-abo/function-args][官网]]

#+begin_src emacs-lisp

  ;; Package function-args
  ;; C++ completion for GNU Emacs
  (use-package function-args
    :disabled
    :config (fa-config-default)
    )
#+end_src

*** assembler

汇编语言模式。 [[https://github.com/skeeto/nasm-mode][官网]]

#+begin_src emacs-lisp
  (use-package nasm-mode
    :mode "\\.\\(nasm\\|s\\|asm\\)$"
    )
#+end_src

*** python

设置python-mode

#+begin_src emacs-lisp

  (use-package python
    :defer t
    :mode ("\\.py\\'" . python-mode)
    ;; :interpreter ("python3" . python-mode)
    :init
    (add-hook 'python-mode-hook 'hs-minor-mode)
    :config
    (setq python-shell-interpreter "python3")
    )
#+end_src

**** python虚拟环境

[[https://github.com/jorgenschaefer/pyvenv][官网]]

#+begin_src emacs-lisp

  ;; python3.3 build-in virtualenv environments
  (use-package pyvenv
    :demand
    :config
    (pyvenv-mode 1)
    )
  (setenv "WORKON_HOME" "/home/wangchang/Programme/pythonCode")
#+end_src

*** go

设置go-mode

#+begin_src emacs-lisp
  (use-package go-mode
    :mode (("\\.go\\'" . go-mode))
    ;; :init (add-hook 'go-mode-hook #'lsp-go-install-save-hooks)
    )
#+end_src

**** go-eldoc

给go语言提供eldoc功能。 [[https://github.com/emacsorphanage/go-eldoc][官网]]

#+begin_src emacs-lisp
  (use-package go-eldoc
    :ensure t
    :defer
    :init
    (add-hook 'go-mode-hook 'go-eldoc-setup))
  (add-hook 'go-mode-hook (lambda () (setq tab-width 4)))
#+end_src

*** web

web开发配置。不太写前端，先这样凑活用着吧

#+begin_src emacs-lisp
  (use-package web-mode
    :ensure t
    :config
    (add-to-list 'auto-mode-alist '("\\.phtml\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.tpl\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.php\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.[agj]sp\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.as[cp]x\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.erb\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.mustache\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.djhtml\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.html?\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("\\.api\\'" . web-mode))
    (add-to-list 'auto-mode-alist '("/some/react/path/.*\\.js[x]?\\'" . web-mode))
    (setq web-mode-engines-alist
          '(("php"    . "\\.phtml\\'")
            ("blade"  . "\\.blade\\."))
          )
    (setq web-mode-content-types-alist
          '(("json" . "/some/path/.*\\.api\\'")
            ("xml"  . "/other/path/.*\\.api\\'")
            ("jsx"  . "/some/react/path/.*\\.js[x]?\\'")))
    (setq web-mode-enable-auto-pairing t)
    (setq web-mode-enable-css-colorization t)
    (setq web-mode-enable-current-column-highlight t)
    (defun my-web-mode-hook ()
      "Hooks for Web mode."
      (setq web-mode-markup-indent-offset 2)
      )
    (add-hook 'web-mode-hook  'my-web-mode-hook))
#+end_src

*** javascript

增强JavaScript编辑模式。 [[https://github.com/mooz/js2-mode][官网]]

不太写js，先这样

#+begin_src emacs-lisp
  (use-package js2-mode
    :ensure t
    :mode "\\.js\\'"
    :bind (("C-c ! n" . js2-next-error))
    :init
    (progn
      (setq-default js2-basic-offset 4)
      (setq-default js2-strict-trailing-comma-warning t)
      (setq-default js2-global-externs
                    '("module"
                      "exports"
                      "require"
                      "process"
                      "setTimeout"
                      "clearTimeout"
                      "setInterval"
                      "clearInterval"
                      "window"
                      "location"
                      "__dirname"
                      "console"
                      "JSON"))
      (add-to-list 'interpreter-mode-alist (cons "node" 'js2-mode)))
    )
#+end_src

*** rust

rust语言

#+begin_src emacs-lisp
  (use-package rust-mode
    :defer t
    :custom
    (rust-format-on-save t)
    )
#+end_src

** 错误自动检查

*** flycheck

自动检查语法, [[https://www.flycheck.org/][官网]]

#+begin_src emacs-lisp
  (use-package flycheck
    :init (global-flycheck-mode)
    :bind
    (("C-c e n" . flycheck-next-error)
     ("C-c e p" . flycheck-previour-error)
     ("C-c e l" . flycheck-list-errors))
    )
#+end_src

*** flycheck-rust

[[https://github.com/flycheck/flycheck-rust][官网]]

#+begin_src emacs-lisp
  (use-package flycheck-rust
    :ensure t
    :config (add-hook 'rust-mode-hook #'flycheck-rust-setup)
    )
#+end_src

** 项目管理

*** projectile

管理项目相关特性。具体见： [[https://github.com/bbatsov/projectile][官网]]

#+begin_src emacs-lisp
  ;; Manage and navigate projects in Emacs easily
  (use-package projectile
    :requires (helm)
    :bind (:map projectile-mode-map
                ("C-c p" . 'projectile-command-map))
    :config
    (setq projectile-enable-caching t
          projectile-indexing-method 'alien
          projectile-completion-system 'helm)
    (projectile-mode +1))
#+end_src

** 版本控制相关

*** magit

[[https://magit.vc/][官网]]

Emacs的git客户端

#+begin_src emacs-lisp
  (use-package magit
    :commands magit-get-top-dir
    :bind (("C-x g s" . magit-status)
           ("C-x g f" . magit-log-buffer-file)
           ("C-x g x" . magit-checkout)
           ("C-x g c" . magit-commit)
           ("C-x g p" . magit-push)
           ("C-x g u" . magit-pull)
           ("C-x g e" . magit-ediff-resolve)
           ("C-x g r" . magit-rebase-interactive))
    :config (magit-auto-revert-mode)
    )
#+end_src

*** git-gutter

[[https://github.com/emacsorphanage/git-gutter][官网]]

Emacs中实时显示修改

#+begin_src emacs-lisp

  (use-package git-gutter+
    :config
    (progn
      (global-git-gutter+-mode)))
#+end_src

** 其他配置

*** cmake-mode

#+begin_src emacs-lisp
  (use-package cmake-mode
    :mode ("CMakeLists.txt" "\\.cmake\\'")
    )
#+end_src

** 调试

*** gud

先用这个吧。以后换成dap吧

#+begin_src emacs-lisp
  ;; (use-package gud
  ;;   :commands gud-gdb
  ;;   :bind (("<f9>" . gud-cont)
  ;;          ("<f10>" . gud-next)
  ;;          ("<f11>" . gud-step)
  ;;          ("S-<f11>" . gud-finish))
  ;;   :init
  ;;   (defun show-debugger ()
  ;;     (interactive)
  ;;     (let ((gud-buf
  ;;            (catch 'found
  ;;              (dolist (buf (buffer-list))
  ;;                (if (string-match "\\*gud-" (buffer-name buf))
  ;;                    (throw 'found buf))))))
  ;;       if (gud-buf
  ;;           (switch-to-buffer-other-window gud-buf)
  ;;           (call-interactively 'gud-gdb))))
  ;;   )
#+end_src

* Org-mode

** org

#+begin_src emacs-lisp

  (use-package org
    :pin gnu
    :mode ("\\.org\\'" . org-mode)
    :hook (org-mode . visual-line-mode)
    :init (setq
           org-use-speed-commands t
           org-return-follows-link t
           org-hide-emphasis-markers t     ; don't display the emphasis markers
           org-outline-path-complete-in-steps nil
           org-startup-indented t
           org-startup-folded 'content
           org-fontify-done-headline t     ;change the face of a headline if it's marked DONE
           org-src-fontity-native t        ;Pretty code blocks
           org-pretty-entities t           ;show entities as UTF-8 characters
           org-hide-leading-stars t        ;hide the stars
           org-src-tab-acts-natively t     ;Make TAB acts as if it were issued from the buffer of the languages's major mode
           truncate-lines t
           org-confirm-babel-evaluate nil) ;don't notify -> "Do you want to execute"
    :config (setq
             org-directory (file-truename "~/Google Driver/All Notes")
             org-todo-keywords
             '((sequence "TODO(t)" "WAITING(w)" "|" "DONE(d)" "CANCELED(c)")))
    (org-babel-do-load-languages 'org-babel-load-languages
                                 (append org-babel-load-languages
                                         '((emacs-lisp . t)
                                           (python . t)
                                           (shell . t)
                                           (C . t)
                                           (ditaa . t)
                                           (js . t)
                                           (go . t))))
    :custom
    (setq org-log-done 'time)
    (setq org-agenda-files (list "~/Google Driver/All Notes/Agenda/work.org"
                                 "~/Google Driver/All Notes/Agenda/study.org"
                                 "~/Google Driver/All Notes/Agenda/life.org"))
    :bind(("C-c l" . org-store-link)
          ("C-c a" . org-agenda)
          ("C-c c" . org-capture))
    )
#+end_src

** org-bullets

#+begin_src emacs-lisp
  ;; really need this package to set the org-bullets by yourself
  (use-package org-bullets
    :init (add-hook 'org-mode-hook 'org-bullets-mode)
    :config
    ;; (setq org-bullets-bullet-list '("☰" "☷" "☯" "☭" "✸" "✿"))
    ;; hexagrams
    ;; (setq org-bullets-bullet-list '("✡" "⎈" "✽" "✲" "✱" "✻" "✼" "✽" "✾" "✿" "❀" "❁" "❂" "❃" "❄" "❅" "❆" "❇"))
    ;; circles
    ;; (setq org-bullets-bullet-list '("○" "☉" "◎" "◉" "○" "◌" "◎" "●" "◦" "◯" "⚪" "⚫" "⚬" "❍" "￮" "⊙" "⊚" "⊛" "∙" "∘"))
    ;; special circles
    ;; (setq org-bullets-bullet-list '("◐" "◑" "◒" "◓" "◴" "◵" "◶" "◷" "⚆" "⚇" "⚈" "⚉" "♁" "⊖" "⊗" "⊘"))
    ;; crosses
    ;; (setq org-bullets-bullet-list '("✙" "♱" "♰" "☥" "✞" "✟" "✝" "†" "✠" "✚" "✜" "✛" "✢" "✣" "✤" "✥"))
    ;; poker sybmols
    ;; (setq org-bullets-bullet-list '("♠" "♣" "♥" "♦" "♤" "♧" "♡" "♢"))
    ;; special symbols
    ;; (setq org-bullets-bullet-list '("☀" "♼" "☼" "☾" "☽" "☣" "§" "¶" "‡" "※" "✕" "△" "◇" "▶" "◀" "◈"))
    (setq org-bullets-bullet-list '("☯" "☰" "☱" "☲" "☳" "☴" "☵" "☶" "☷")) ;
    (setq org-ellipsis "▼"))
#+end_src

** org-tempo

#+begin_src emacs-lisp
  ;; for '<s/e/c... TAB'  completion
  ;; or "C-c C-,"
  (require 'org-tempo)
  (add-to-list 'org-structure-template-alist '("sh" . "src shell"))
  (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
  (add-to-list 'org-structure-template-alist '("py" . "src python"))
  (add-to-list 'org-structure-template-alist '("go" . "src go"))
  (add-to-list 'org-structure-template-alist '("sc" . "src c"))
  (add-to-list 'org-structure-template-alist '("scpp" . "src c++"))
#+end_src

** ob-go

#+begin_src emacs-lisp
  (use-package ob-go)
#+end_src

** ox-reveal

#+begin_src emacs-lisp
  (use-package ox-reveal)
#+end_src

** ox-gfm

#+begin_src emacs-lisp
  (use-package ox-gfm)
#+end_src

** toc-org

#+begin_src emacs-lisp
  ;; maintain TOC(table of contents) automatically
  ;; put :TOC: tag to a heading, run M-x toc-org-insert-toc
  (use-package toc-org
    :after org)
#+end_src

** org-mime

#+begin_src emacs-lisp
  ;; WYSIWYG, html mime composition using org-mode
  (use-package org-mime)
#+end_src

** org-download

#+begin_src emacs-lisp
  ;; TODO
  (use-package org-download
    :after org
    :custom
    (org-download-method 'directory)
    (org-download-timestamp "%Y%m%d-%H%M%S_")
    (setq-default org-download-heading-lvl nil)
    (setq-default org-download-image-dir "./images")
    :config
    (require 'org-download)
    )
#+end_src

** org-roam

#+begin_src emacs-lisp
  ;; org-roam
  ;; org-roam is Version 2 now, So we use org-roam-ui for graphic,
  ;; not org-roam-server which only support org-roam Version 1
  (use-package org-roam
    :custom
    (org-roam-directory "~/Google Driver/brain-notes")
    (org-roam-db-location "~/Google Driver/brain-notes/org-roam.db")
    (org-roam-db-gc-threshold most-positive-fixnum)
    (org-roam-completion-everywhere t)
    (org-roam-db-autosync-mode)
    (add-hook 'after-init-hook 'org-roam-mode)
    :bind (("C-c n l" . org-roam-buffer-toggle)
           ("C-c n f" . org-roam-node-find)
           ("C-c n i" . org-roam-node-insert))
    :config (org-roam-setup)
    )
#+end_src

** org-roam-ui

#+begin_src emacs-lisp
  ;; org-roam-ui
  (use-package org-roam-ui
    :after org-roam
    :config
    (setq org-roam-ui-sync-theme t
          org-roam-ui-follow t
          org-roam-ui-update-on-save t
          org-roam-ui-open-on-start nil))
#+end_src


* 结尾

#+begin_src emacs-lisp
  (provide 'config.el)
  ;;; init.el ends here
#+end_src
